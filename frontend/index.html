<script>
  async function sendMessage() {
    const input = document.getElementById("userInput");
    const fileInput = document.getElementById("fileInput");
    const chat = document.getElementById("chat");

    const message = input.value.trim();
    if (!message && fileInput.files.length === 0) return;

    const userMsg = document.createElement("div");
    userMsg.className = "message user";
    userMsg.textContent = "🧑‍💻 " + message;
    chat.appendChild(userMsg);
    chat.scrollTop = chat.scrollHeight;

    const file = fileInput.files[0];
    let fileData = null;
    let fileName = null;

    if (file) {
      const arrayBuffer = await file.arrayBuffer();
      const uint8Array = new Uint8Array(arrayBuffer);
      fileData = btoa(String.fromCharCode(...uint8Array));
      fileName = file.name;
    }

    input.value = "";
    fileInput.value = "";

    const payload = {
      message,
      fileName,
      fileData,
    };

    try {
      const res = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (res.status === 200 && res.headers.get("Content-Type") === "application/pdf") {
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "risultato.pdf";
        link.textContent = "📄 Scarica PDF generato";
        link.target = "_blank";

        const msg = document.createElement("div");
        msg.className = "message assistant";
        msg.appendChild(link);
        chat.appendChild(msg);
      } else {
        const data = await res.json();
        const reply = document.createElement("div");
        reply.className = "message assistant";
        reply.textContent = "🤖 " + (data.reply || data.error || "Errore");
        chat.appendChild(reply);
      }

      chat.scrollTop = chat.scrollHeight;
    } catch (err) {
      const errMsg = document.createElement("div");
      errMsg.className = "message assistant";
      errMsg.textContent = "❌ Errore: " + err.message;
      chat.appendChild(errMsg);
    }
  }

  document.getElementById("userInput").addEventListener("keydown", (e) => {
    if (e.key === "Enter") sendMessage();
  });
</script>
