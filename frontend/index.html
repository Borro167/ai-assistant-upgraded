<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Assistant Regressivo</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      padding: 2rem;
      max-width: 600px;
      margin: auto;
    }
    #chat {
      border: 1px solid #ccc;
      background: white;
      padding: 1rem;
      height: 400px;
      overflow-y: auto;
      margin-bottom: 1rem;
    }
    .message {
      margin-bottom: 0.75rem;
    }
    .user { font-weight: bold; }
    .assistant { color: green; }
    #fileInput {
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>

  <h1>Chat con AI</h1>

  <div id="chat"></div>

  <input type="file" id="fileInput" />
  <br />
  <input type="text" id="userInput" placeholder="Scrivi un messaggio..." style="width: 80%;" />
  <button onclick="sendMessage()">Invia</button>

  <script>
    async function sendMessage() {
      const input = document.getElementById("userInput");
      const fileInput = document.getElementById("fileInput");
      const chat = document.getElementById("chat");

      const message = input.value.trim();
      if (!message && fileInput.files.length === 0) return;

      const userMsg = document.createElement("div");
      userMsg.className = "message user";
      userMsg.textContent = "🧑‍💻 " + message;
      chat.appendChild(userMsg);
      chat.scrollTop = chat.scrollHeight;

      // Prepara il payload (usa FormData se c'è un file, JSON altrimenti)
      let fetchOptions;
      if (fileInput.files.length > 0) {
        // Con file: multipart/form-data
        const formData = new FormData();
        formData.append("message", message);
        formData.append("file", fileInput.files[0]);
        fetchOptions = {
          method: "POST",
          body: formData,
        };
      } else {
        // Solo testo: JSON
        fetchOptions = {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message }),
        };
      }

      input.value = "";
      fileInput.value = "";

      try {
        // FETCH GIUSTA PER NETLIFY (funziona sia in locale che in prod)
        const res = await fetch(window.location.origin + "/api/chat", fetchOptions);

        // Gestione risposta PDF
        if (res.status === 200 && res.headers.get("Content-Type") === "application/pdf") {
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = "risultato.pdf";
          link.textContent = "📄 Scarica PDF generato";
          link.target = "_blank";
          const msg = document.createElement("div");
          msg.className = "message assistant";
          msg.appendChild(link);
          chat.appendChild(msg);
        } else {
          // Gestione risposta testuale/errore
          const data = await res.json();
          const reply = document.createElement("div");
          reply.className = "message assistant";
          reply.textContent = "🤖 " + (data.reply || data.error || "Errore");
          chat.appendChild(reply);
        }

        chat.scrollTop = chat.scrollHeight;
      } catch (err) {
        const errMsg = document.createElement("div");
        errMsg.className = "message assistant";
        errMsg.textContent = "❌ Errore: " + err.message;
        chat.appendChild(errMsg);
      }
    }

    // Enter per inviare
    document.getElementById("userInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendMessage();
    });
  </script>

</body>
</html>
